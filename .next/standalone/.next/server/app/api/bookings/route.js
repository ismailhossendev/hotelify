"use strict";(()=>{var e={};e.id=1946,e.ids=[1946,4666,6511],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},27783:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>q,originalPathname:()=>O,patchFetch:()=>T,requestAsyncStorage:()=>v,routeModule:()=>w,serverHooks:()=>N,staticGenerationAsyncStorage:()=>R,staticGenerationBailout:()=>D});var n={};r.r(n),r.d(n,{GET:()=>x,POST:()=>k});var o=r(95419),a=r(69108),i=r(99678),s=r(98984),d=r(56511),u=r(98633),l=r(71309),c=r(70745),p=r(74666),m=r(96467),g=r(65256);let y=g.Ry({roomId:g.Z_().min(1,"Room is required"),roomUnitId:g.Z_().optional(),checkIn:g.Z_().datetime({message:"Invalid check-in date"}),checkOut:g.Z_().datetime({message:"Invalid check-out date"}),guests:g.Ry({adults:g.Rx().min(1,"At least 1 adult required").max(10),children:g.Rx().min(0).max(10).default(0)}),guestDetails:g.Ry({name:g.Z_().min(2,"Name is required"),email:g.Z_().email().optional().or(g.i0("")),phone:g.Z_().min(11,"Valid phone number required"),nid:g.Z_().optional(),address:g.Z_().optional()}),specialRequests:g.Z_().max(500).optional(),paymentMethod:g.Km(["cash","bkash","nagad","card"]).optional()}).refine(e=>{let t=new Date(e.checkIn);return new Date(e.checkOut)>t},{message:"Check-out must be after check-in"});async function h(e,t,r){let{checkIn:n,checkOut:o}=t,a={roomId:e,status:{$nin:["cancelled","no_show","checked_out"]},$and:[{checkIn:{$lt:o}},{checkOut:{$gt:n}}]};r&&(a._id={$ne:r}),await u.$.findOne(a);let i=await l.d.findById(e);return!!i&&await u.$.countDocuments(a)<i.totalRooms}async function f(e,t){let r=await l.d.findById(e);if(!r)throw Error("Room not found");let n=[],o=0,a=new Date(t.checkIn),i=new Date(t.checkOut);for(;a<i;){let e=new Date(a),t=r.getPriceForDate(e);n.push({date:e,price:t}),o+=t,a.setDate(a.getDate()+1)}return{subtotal:o,breakdown:n,total:o}}g.Ry({amount:g.Rx().positive("Amount must be positive"),method:g.Km(["cash","bkash","nagad","card","bank"]),transactionId:g.Z_().optional()});var S=r(60795),b=r(11185),I=r.n(b);async function k(e){try{let t=await (0,m.ts)();if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});await (0,d.default)();let r=await e.json(),n=y.safeParse(r);if(!n.success)return s.NextResponse.json({error:"Validation failed",details:n.error.format()},{status:400});let{roomId:o,roomUnitId:a,checkIn:i,checkOut:p,guestDetails:g,specialRequests:b,paymentMethod:I}=n.data,k=new Date(i),x=new Date(p);if(a){let e=await c.E.findById(a);if(!e)return s.NextResponse.json({error:"Selected Room Unit not found"},{status:404});if(e.roomTypeId.toString()!==o)return s.NextResponse.json({error:"Room Unit does not match Room Type"},{status:400});if(await u.$.findOne({roomUnitId:a,status:{$in:["confirmed","checked_in"]},$or:[{checkIn:{$lt:x},checkOut:{$gt:k}}]}))return s.NextResponse.json({error:"Room Unit "+e.roomNo+" is already occupied for these dates"},{status:409})}let w=await l.d.findById(o);if(!w)return s.NextResponse.json({error:"Room not found"},{status:404});if(!await h(o,{checkIn:k,checkOut:x}))return s.NextResponse.json({error:"Room not available for selected dates"},{status:409});let v=await f(o,{checkIn:k,checkOut:x}),R="online",N="pending";(t.role.includes("vendor")||"super_admin"===t.role)&&(R="walk_in",N="confirmed");let q=`BK-${Date.now().toString().slice(-6)}-${Math.floor(1e3*Math.random())}`,D=await u.$.create({hotelId:w.hotelId,roomId:o,roomUnitId:a||void 0,guestId:"guest"===t.role?t.userId:null,bookingNumber:q,bookingType:R,status:N,guestDetails:g,checkIn:k,checkOut:x,nights:Math.ceil((x.getTime()-k.getTime())/864e5),guests:n.data.guests,pricing:{roomCharges:v.breakdown,subtotal:v.subtotal,totalAmount:v.total},specialRequests:b,createdBy:t.userId});return await S.o.create({hotelId:w.hotelId,userId:t.userId,action:"create",entityType:"Booking",entityId:D._id,description:`Booking created ${q}`}),s.NextResponse.json({success:!0,booking:D},{status:201})}catch(e){return console.error("Create booking error:",e),s.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:String(e)},{status:500})}}async function x(e){try{let t=await (0,m.ts)();if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});await (0,d.default)();let{searchParams:r}=new URL(e.url),n=r.get("status"),o=r.get("type"),a={};if("guest"===t.role)a.guestId=t.userId;else if("super_admin"!==t.role){if(!t.hotelId)return s.NextResponse.json({bookings:[]});a.hotelId=t.hotelId}n&&(a.status=n),o&&(a.bookingType=o),I().models.User||(console.log("Registering User model explicitly"),p.User);let i=await u.$.find(a).populate("roomId","name roomType").populate("guestId","profile.name").populate("roomUnitId","roomNo status").sort({createdAt:-1}).limit(50);return console.log("[DEBUG] GET /bookings",{userId:t.userId,hotelId:t.hotelId,query:a,count:i.length}),s.NextResponse.json({success:!0,bookings:i})}catch(e){return console.error("GET bookings error:",e),s.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:String(e)},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:"app/api/bookings/route"},resolvedPagePath:"C:\\Users\\ismai\\.gemini\\antigravity\\playground\\primal-supernova\\src\\app\\api\\bookings\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:v,staticGenerationAsyncStorage:R,serverHooks:N,headerHooks:q,staticGenerationBailout:D}=w,O="/api/bookings/route";function T(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:R})}},96467:(e,t,r)=>{r.d(t,{WX:()=>d,setAuthCookie:()=>u,signToken:()=>s,ts:()=>l});var n=r(46082),o=r.n(n),a=r(7439);let i=process.env.JWT_SECRET||"fallback-secret-key-change-me";function s(e,t="6h"){return o().sign(e,i,{expiresIn:t})}function d(e){try{return o().verify(e,i)}catch(e){return null}}function u(e,t=21600){(0,a.cookies)().set("auth_token",e,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:t,path:"/"})}async function l(){let e=function(){let e=(0,a.cookies)();return e.get("auth_token")?.value}();return e?d(e):null}},56511:(e,t,r)=>{r.d(t,{default:()=>s});var n=r(11185),o=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let i=global.mongoose;i||(i=global.mongoose={conn:null,promise:null});let s=async function(){if(i.conn)return i.conn;i.promise||(i.promise=o().connect(a,{bufferCommands:!1}).then(e=>e));try{i.conn=await i.promise}catch(e){throw i.promise=null,e}return i.conn}},60795:(e,t,r)=>{r.d(t,{o:()=>i});var n=r(11185),o=r.n(n);let a=new(o()).Schema({hotelId:{type:o().Schema.Types.ObjectId,ref:"Hotel",index:!0},userId:{type:o().Schema.Types.ObjectId,ref:"User",required:!0},action:{type:String,enum:["login","logout","failed_login","create","update","delete","booking_confirm","booking_cancel","booking_checkout","payment_received","withdrawal_request","withdrawal_approve","settings_change","permission_change"],required:!0},entityType:String,entityId:o().Schema.Types.ObjectId,changes:{before:o().Schema.Types.Mixed,after:o().Schema.Types.Mixed},description:String,ipAddress:String,userAgent:String,isImmutable:{type:Boolean,default:!0}},{timestamps:{createdAt:!0,updatedAt:!1}});a.index({hotelId:1,createdAt:-1}),a.index({userId:1,action:1}),a.index({entityType:1,entityId:1});let i=o().models.AuditLog||o().model("AuditLog",a)},98633:(e,t,r)=>{r.d(t,{$:()=>i});var n=r(11185),o=r.n(n);let a=new(o()).Schema({hotelId:{type:o().Schema.Types.ObjectId,ref:"Hotel",required:!0,index:!0},roomId:{type:o().Schema.Types.ObjectId,ref:"Room",required:!0},roomUnitId:{type:o().Schema.Types.ObjectId,ref:"RoomUnit"},guestId:{type:o().Schema.Types.ObjectId,ref:"User"},bookingNumber:{type:String,unique:!0},bookingType:{type:String,enum:["online","offline","walk_in"],required:!0},parentBookingId:{type:o().Schema.Types.ObjectId,ref:"Booking"},isMerged:{type:Boolean,default:!1},guestDetails:{name:{type:String,required:!0},email:String,phone:{type:String,required:!0},nid:String,address:String,nationality:{type:String,default:"Bangladeshi"},documents:[{type:String,url:String}]},checkIn:{type:Date,required:!0},checkOut:{type:Date,required:!0},nights:{type:Number,required:!0},guests:{adults:{type:Number,default:1},children:{type:Number,default:0}},additionalGuests:[{name:{type:String,required:!0},age:Number,nid:String}],pricing:{roomCharges:[{date:Date,price:Number}],subtotal:{type:Number,required:!0},taxes:{type:Number,default:0},extraBedCharges:{type:Number,default:0},discount:{type:Number,default:0},discountReason:String,coupon:{offerId:{type:o().Schema.Types.ObjectId,ref:"Offer"},code:String,discountAmount:{type:Number,default:0}},totalAmount:{type:Number,required:!0}},posCharges:[{orderId:{type:o().Schema.Types.ObjectId,ref:"POSOrder"},amount:Number,description:String,createdAt:{type:Date,default:Date.now}}],grandTotal:{type:Number},paymentStatus:{type:String,enum:["pending","partial","paid","refunded"],default:"pending"},payments:[{method:{type:String,enum:["cash","bkash","nagad","card","bank"]},amount:Number,transactionId:String,paidAt:Date,receivedBy:{type:o().Schema.Types.ObjectId,ref:"User"}}],amountPaid:{type:Number,default:0},amountDue:{type:Number},status:{type:String,enum:["pending","confirmed","checked_in","checked_out","cancelled","no_show"],default:"pending"},confirmedAt:Date,checkedInAt:Date,checkedOutAt:Date,cancelledAt:Date,requiresApproval:{type:Boolean,default:!1},approvalStatus:{type:String,enum:["pending","approved","rejected"]},approvedBy:{type:o().Schema.Types.ObjectId,ref:"User"},rejectionReason:String,specialRequests:String,internalNotes:String,createdBy:{type:o().Schema.Types.ObjectId,ref:"User"},lastModifiedBy:{type:o().Schema.Types.ObjectId,ref:"User"},commission:{rate:Number,amount:Number,collected:{type:Boolean,default:!1}}},{timestamps:!0});a.index({hotelId:1,checkIn:1,checkOut:1}),a.index({hotelId:1,status:1}),a.index({guestId:1});let i=o().models.Booking||o().model("Booking",a)},71309:(e,t,r)=>{r.d(t,{d:()=>i});var n=r(11185),o=r.n(n);let a=new(o()).Schema({hotelId:{type:o().Schema.Types.ObjectId,ref:"Hotel",required:!0,index:!0},name:{type:String,required:!0},roomType:{type:String,enum:["single","double","twin","suite","family","dormitory","standard","deluxe"]},description:String,capacity:{adults:{type:Number,default:2},children:{type:Number,default:0},extraBedAllowed:{type:Boolean,default:!1}},totalRooms:{type:Number,default:1,min:1},basePrice:{type:Number,required:!0},extraBedCharge:{type:Number,default:0},seasonalPricing:[{name:String,startDate:{type:Date,required:!0},endDate:{type:Date,required:!0},price:{type:Number,required:!0},isActive:{type:Boolean,default:!0}}],weekendPricing:{enabled:{type:Boolean,default:!0},price:Number,days:{type:[Number],default:[5,6]}},specialRates:[{date:{type:Date,required:!0},price:{type:Number,required:!0},note:String}],images:[{url:String,caption:String,isPrimary:Boolean}],amenities:[String],housekeepingStatus:{type:String,enum:["clean","dirty","maintenance","inspecting"],default:"clean"},isActive:{type:Boolean,default:!0},sortOrder:{type:Number,default:0}},{timestamps:!0});a.index({hotelId:1,isActive:1}),a.methods.getPriceForDate=function(e){let t=new Date(e);t.setHours(0,0,0,0);let r=(this.specialRates||[]).find(e=>new Date(e.date).setHours(0,0,0,0)===t.getTime());if(r)return r.price;let n=(this.seasonalPricing||[]).find(e=>e.isActive&&t>=new Date(e.startDate)&&t<=new Date(e.endDate));if(n)return n.price;let o=t.getDay();return this.weekendPricing?.enabled&&(this.weekendPricing.days||[5,6]).includes(o)&&this.weekendPricing.price||this.basePrice};let i=o().models.Room||o().model("Room",a)},70745:(e,t,r)=>{r.d(t,{E:()=>i});var n=r(11185),o=r.n(n);let a=new(o()).Schema({hotelId:{type:o().Schema.Types.ObjectId,ref:"Hotel",required:!0,index:!0},roomTypeId:{type:o().Schema.Types.ObjectId,ref:"Room",required:!0,index:!0},roomNo:{type:String,required:!0},floor:{type:String,default:"1st"},status:{type:String,enum:["clean","dirty","maintenance","occupied"],default:"clean"},notes:String,isActive:{type:Boolean,default:!0}},{timestamps:!0});a.index({hotelId:1,roomNo:1},{unique:!0});let i=o().models.RoomUnit||o().model("RoomUnit",a)},74666:(e,t,r)=>{r.d(t,{User:()=>i});var n=r(11185),o=r.n(n);let a=new(o()).Schema({email:{type:String,unique:!0,sparse:!0,lowercase:!0},phone:{type:String,unique:!0,sparse:!0},passwordHash:{type:String,select:!1},otp:{type:String,select:!1},otpExpires:Date,resetPasswordToken:{type:String,select:!1},resetPasswordExpire:Date,role:{type:String,enum:["super_admin","vendor_admin","vendor_staff","guest"],default:"guest"},hotelId:{type:o().Schema.Types.ObjectId,ref:"Hotel",index:!0},permissions:[{type:String,enum:["bookings","rooms","pos","reports","housekeeping","withdrawal","settings"]}],staffRole:{type:String,enum:["manager","receptionist","cleaner","pos_operator"]},profile:{name:{type:String,required:!0},avatar:String,address:String,nid:String},favorites:[{type:o().Schema.Types.ObjectId,ref:"Hotel"}],providers:[{name:{type:String,enum:["google","facebook"]},providerId:String}],twoFactorEnabled:{type:Boolean,default:!1},twoFactorSecret:{type:String,select:!1},lastLoginAt:Date,isActive:{type:Boolean,default:!0},isVerified:{type:Boolean,default:!1},language:{type:String,enum:["bn","en","hi"],default:"en"}},{timestamps:!0});a.index({hotelId:1,role:1});let i=o().models.User||o().model("User",a)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1638,7439,6082,2791,5256],()=>r(27783));module.exports=n})();